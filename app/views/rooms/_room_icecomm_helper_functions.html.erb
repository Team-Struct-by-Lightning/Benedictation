var comm = new Icecomm('9gv3ODZorBS2kVuNwnugBeV432PcNX3Qn0HmW33ofxK/u5Xolu', {debug: true});
comm.connect(window.location.pathname);

    // Set up the WebSocket
   var myLocation = location.host;
 var port = "8888";
 var websocketprotocol = "wss://";
 if (location.protocol !== "https:") {
     websocketprotocol = "ws://";
     myLocation = myLocation.split(":")[0];
 }
 var uri = "/recognize";
 console.log("connecting to this websocket: " + websocketprotocol + myLocation + ":" + port + uri);
 ws = new WebSocket(websocketprotocol + myLocation + ":" + port + uri);

    // get benedict's reply from the python server
    ws.onmessage = function(e) {
        console.log("data from server: ", e.data);
        if(e.data != ""){
            try {
                var myData = JSON.parse(e.data);
                $.ajax({
                    type: "POST",
                    url: "/check_api",
                    data: {jsonData: JSON.stringify(myData)}
                });
            } catch (e) {
                console.log("data from server not JSON");
            }
            sendBennyReply(e.data);
        }

        ready_to_record = 1;
        recordSpeech.recording = 0;
        count_b = 0;
    }

    // Initialize Icecomm
    console.log("Initialized Icecomm, waiting for user media permissions...");

    comm.on('local', function(options) {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        ready_to_record = 1;
        localVideo.src = options.stream;
        localAudioStream = options.rawStream;
        localVideo.muted = true;
        console.log(localAudioStream.getAudioTracks());
        console.log("Obtained user camera/microphone approval");

        // Initialize our new recorder with its own copy of the local media stream
        var input = audioContext.createMediaStreamSource(localAudioStream);
        speechRegRec = new Recorder(input);
    });

    comm.on('connected', function(options) {
        document.getElementById("video-chat-body").appendChild(options.getVideo());

    });

    comm.on('disconnect', function(options) {
        console.log('disconnect happening');
        document.getElementById(options.ID).remove();
    });

    comm.on('data', function(options) {
        console.log("data: ",options.data);
        var message_data = options.data.split("@@@");
        if(message_data[0] === "benny"){
            appendNewBennyReply(options);
        }
        else{
            appendNewIM(options);
        }
    });
