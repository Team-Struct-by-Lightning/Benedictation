var comm = new Icecomm('9gv3ODZorBS2kVuNwnugBeV432PcNX3Qn0HmW33ofxK/u5Xolu', {
    debug: true
});
comm.connect(window.location.pathname);
// Set up the WebSocket
var myLocation = location.host;
var port = "8888";
var websocketprotocol = "wss://";
if (location.protocol !== "https:") {
    websocketprotocol = "ws://";
    myLocation = myLocation.split(":")[0];
}
var uri = "/recognize";
console.log("connecting to this websocket: " + websocketprotocol + myLocation + ":" + port + uri);
ws = new WebSocket(websocketprotocol + myLocation + ":" + port + uri);
// get benedict's reply from the python server
ws.onmessage = function(e) {
    console.log("data from server: ", e.data);
    if (e.data != "") {
        try {
            var myData = JSON.parse(e.data);
            $.ajax({
                type: "POST",
                url: "/check_api",
                data: {
                    jsonData: JSON.stringify(myData)
                }
            });
        } catch (e) {
            console.log("data from server not JSON");
        }
        sendBennyReply(e.data);
    }
    ready_to_record = 1;
    recordSpeech.recording = 0;
    count_b = 0;
}
// Initialize Icecomm
console.log("Initialized Icecomm, waiting for user media permissions...");
comm.on('local', function(options) {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    audioContext = new AudioContext();
    ready_to_record = 1;
    localVideo.src = options.stream;
    localAudioStream = options.rawStream;
    localVideo.muted = true;
    console.log(localAudioStream.getAudioTracks());
    console.log("Obtained user camera/microphone approval");
    // fill in chat history from redis
    var chat_history;
    // send to redis
    var url = (window.location.pathname).split("/");
    var id = String(url[url.length - 2]);
    var name = String(url[url.length - 1]);
    var key = name + ":" + id + ":chathistory";
    
    // this will work later when icecomm's comm.getRoomSize() is functional
    //if (comm.getHost()) {
        $.ajax({
            type: "GET",
            url: "/get_chat_history",
            dataType: "json",
            data: {
                'redis_key': key
            },
            success: function(messages) {
                console.log("messages: ", messages);
                if (messages.length != 0) {
                    // append what you send to your own page
                    for (var i = 0; i < messages.length; i++) {
                        appendNewIM_text_only(messages[i]);
                        //Do something
                    }
                }
            }
        });
    //}
    // Initialize our new recorder with its own copy of the local media stream
    var input = audioContext.createMediaStreamSource(localAudioStream);
    speechRegRec = new Recorder(input);
});
comm.on('connected', function(options) {
    document.getElementById(get_free_spot()).appendChild(options.getVideo());
    slot_num = get_free_spot().slice(-1) - 1;
    var new_video = document.getElementById(options.callerID);
    video_spots[slot_num] = $(new_video).attr('id');
    new_video.style.width = "100%";
    new_video.style.height = "100%";
    new_video.style.margin = "0px";
    new_video.style.cursor = "move";
    $(new_video).draggable({
        revert: "invalid",
        opacity: .7,
        create: function(event, ui) {
            $(this).draggable("option", "cursorAt", {
                left: Math.floor(80),
                top: Math.floor(60)
            });
        },
        start: function(event, ui) {
            if ($(this).width() > 160) {
                $(this).css("width", "160px");
                $(this).css("height", "120px");
            }
        }
    });
});
comm.on('disconnect', function(options) {
    console.log('disconnect happening');
    document.getElementById(options.ID).remove();
    var url = (window.location.pathname).split("/");
    var id = String(url[url.length - 2]);
    var name = String(url[url.length - 1]);
    var key = name + ":" + id + ":chathistory";

    // this will work later when icecomm's comm.getRoomSize() is functional
    // if (comm.getRoomSize() == 1 && id.to_i.to_s == id) {
    //     $.ajax({
    //         type: "POST",
    //         url: "/clear_chat_history",
    //         data: {
    //             redis_key: key,
    //             message: message_string
    //         }
    //     });
    // }
});
comm.on('data', function(options) {
    console.log("data: ", options.data);
    var message_data = options.data.split("@@@");
    if (message_data[0] === "benny") {
        appendNewBennyReply(options);
    } else {
        appendNewIM(options);
    }
});